---
layout: post
title:  "Mysql的备份和还原"
date:   2016-12-09 22:22:23
categories: mysql
permalink: /archivers/mysql_backup
---
# Mysql : Mysql的备份和还原
----
----

### 问题背景

----
这两天在做Mysql的数据备份和还原，查询了很多资料，记录下来，主要的需求是：
  * 有误操作的时候，可以进行还原，防止数据遗失。
  * 做数据库的容灾，在其他数据库上做备份。

### 解决方案
----
因为数据量不是很大，所以使用mysqldump + mysqlbinlog去解决这个问题，思路如下：
  * mysqldump做全局备份，每天12点的时候会使用mysqldump生成sql文件，并保存下来。
  * mysqlbinlog做增量备份，mysqlbinlog的保存周期为1天。

### mysqldump
----
mysqldump客户端可用来转储数据库或搜集数据库进行备份或将数据转移到另一个SQL服务器(不一定是一个MySQL服务器)。转储包含创建表和/或装载表的SQL语句。

编写的Shell脚本片段，执行之后会生成类似 tableName-2016-12-10.sql：

{% highlight shell %}
# mysqldump skip one table
# -- Warning: Skipping the data of table mysql.event. Specify the --events option explicitly.
# mysqldump --ignore-table=mysql.event
# http://serverfault.com/questions/376904/mysqldump-skip-one-table
# --routines，备份存储过程和函数
# --events，跳过mysql.event表
# --triggers，备份触发器
# --single-transaction，针对InnoDB，在单次事务中通过转储所有数据库表创建一个一致性的快照，此选项会导致自动锁表，因此不需要--lock-all-tables
# --flush-logs，在dump转储前刷新日志
# --ignore-table，忽略某个表，--ignore-table=database.table
# --master-data=2 ，如果启用MySQL复制功能，则可以添加这个选项
# 将dump出的sql语句用gzip压缩到一个以时间命名的文件
mysqldump --user=${mySqlUserName} --password=${mysqlPassWd} --routines --events --triggers --single-transaction --flush-logs --ignore-table=mysql.event --databases ${dataBaseName} | gzip > ${backupLocation}/${dataBaseName}-${dateFormat}.sql.gz
# 检查执行结果，如果错误代码为0则输出成功，否则输出失败
[ $? -eq 0 ] && echo "备份" ${dataBaseName} "成功, 产生的sql压缩文件在" ${backupLocation}/${dataBaseName}-${dateFormat}.sql.gz || echo "备份失败"
{% endhighlight %}

### mysqlbinlog
----
